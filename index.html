<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor Pro</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e3e3e3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="MD Editor">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">

    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/highlight.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.7/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-toolkit@6.6.0/lib/js/joypixels.min.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --sidebar-bg: #5f676e;
            --toolbar-bg: #f1f1f1;
            --editor-bg: #f6f8fa;
            --border-color: #ddd;
            --text-color: #24292e;
            --link-color: #0366d6;
            --blockquote-color: #6a737d;
            --code-bg: rgba(27,31,35,0.05);
            --table-border: #dfe2e5;
            --table-alt-bg: #f6f8fa;
            --button-hover: #e1e4e8;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; background-color: #f5f5f5; color: var(--text-color); overflow: hidden;}
        #sidebar { width: 40px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        #sidebar button { background: none; border: none; color: white; font-size: 16px; margin-bottom: 15px; cursor: pointer; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 5px; transition: background-color 0.2s; }
        #sidebar button:hover { background-color: #444; }
        #main-container { flex: 1; display: flex; overflow: hidden; }
        
        #dropzone { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; font-size: 18px; cursor: pointer; text-align: center; padding: 20px; transition: background-color 0.2s; }
        #dropzone:hover { background-color: #e9e9e9; }
        #dropzone-icon { font-size: 48px; margin-bottom: 20px; color: #999; }
        .dropzone-action-separator { margin: 15px 0; font-size: 14px; opacity: 0.6; }
        #create-new-btn-landing { padding: 10px 20px; background-color: #fff; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; font-size: 16px; color: #333; transition: all 0.2s; z-index: 10; }
        #create-new-btn-landing:hover { background-color: var(--button-hover); border-color: #bbb; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        #editor-container { width: 100%; height: 100%; display: none; flex-direction: row; }
        #editor-section { width: 50%; height: 100%; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        #toolbar { background-color: var(--toolbar-bg); padding: 5px; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; }
        #toolbar button { background-color: #fff; border: 1px solid var(--border-color); border-radius: 3px; color: #333; cursor: pointer; margin-right: 5px; margin-bottom: 5px; padding: 3px 5px; font-size: 14px; transition: background-color 0.2s; }
        #toolbar button:hover { background-color: var(--button-hover); }
        #editor { flex: 1; overflow: auto; padding: 15px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 14px; line-height: 1.5; border: none; resize: none; background-color: var(--editor-bg); tab-size: 4; }
        
        #preview-container { 
            width: 50%; 
            height: 100%; 
            overflow: auto; 
            padding: 0; 
            background-color: white;
        }

        #preview { max-width: 980px; margin: 0 auto; padding: 20px; font-size: 16px; line-height: 1.6; color: var(--text-color); word-wrap: break-word; }
        
        /* 宽屏模式 */
        .wide-mode #preview {
            max-width: 100%;
            padding: 20px 40px;
        }
        
        /* Preview Styles */
        #preview h1, #preview h2 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h1 { font-size: 2em; }
        #preview h2 { font-size: 1.5em; }
        #preview h3 { font-size: 1.25em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h4 { font-size: 1em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h5 { font-size: 0.875em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h6 { font-size: 0.85em; color: #6a737d; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview blockquote { padding: 0 1em; color: var(--blockquote-color); border-left: 0.25em solid #dfe2e5; margin: 0 0 16px 0; }
        #preview pre { padding: 16px; overflow: auto; font-size: 85%; line-height: 1.45; background-color: var(--editor-bg); border-radius: 6px; margin-bottom: 16px; }
        #preview code { padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: var(--code-bg); border-radius: 3px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
        #preview pre code { padding: 0; background-color: transparent; border-radius: 0; }
        #preview table { border-collapse: collapse; width: 100%; margin-bottom: 16px; display: block; overflow-x: auto; }
        #preview table th, #preview table td { padding: 6px 13px; border: 1px solid var(--table-border); }
        #preview table tr { background-color: #fff; border-top: 1px solid #c6cbd1; }
        #preview table tr:nth-child(2n) { background-color: var(--table-alt-bg); }
        #preview img { max-width: 100%; box-sizing: content-box; background-color: #fff; }
        #preview p { margin-top: 0; margin-bottom: 16px; }
        #preview a { color: var(--link-color); text-decoration: none; }
        #preview a:hover { text-decoration: underline; }
        #preview ul, #preview ol { padding-left: 2em; margin-top: 0; margin-bottom: 16px; }
        #preview li+li { margin-top: 0.25em; }
        #preview hr { height: 0.25em; padding: 0; margin: 24px 0; background-color: #e1e4e8; border: 0; }
        #preview .task-list-item { list-style-type: none; }
        #preview .task-list-item-checkbox { margin: 0 0.2em 0.25em -1.6em; vertical-align: middle; }

        /* Diagram styles */
        .diagram-container, .mermaid-container {
          position: relative;
          margin: 1rem 0;
          border: 1px solid var(--border-color);
          border-radius: 4px;
          overflow: auto;
        }
        .diagram-loading {
          padding: 1rem;
          font-style: italic;
          color: #666;
        }
        .diagram-error {
          padding: 1rem;
          color: #dc3545;
          background-color: #f8d7da;
          border-radius: 4px;
        }
        .diagram-toolbar {
          position: absolute;
          top: 5px;
          right: 5px;
          display: flex;
          gap: 5px;
          z-index: 100;
        }
        .diagram-toolbar button {
          padding: 2px 8px;
          background: rgba(255,255,255,0.9);
          border: 1px solid var(--border-color);
          border-radius: 3px;
          cursor: pointer;
          font-size: 12px;
        }
        .diagram-toolbar button:hover {
          background: var(--button-hover);
        }
        
        /* Enhanced diagram export dropdown */
        .diagram-export-dropdown {
          position: relative;
          display: inline-block;
        }
        .diagram-export-dropdown .dropdown-content {
          display: none;
          position: absolute;
          right: 0;
          background-color: white;
          min-width: 120px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
          border-radius: 4px;
          z-index: 200;
          overflow: hidden;
        }
        .diagram-export-dropdown:hover .dropdown-content {
          display: block;
        }
        .dropdown-content button {
          width: 100%;
          padding: 8px 12px !important;
          text-align: left;
          border: none !important;
          border-radius: 0 !important;
          background: white !important;
        }
        .dropdown-content button:hover {
          background: var(--button-hover) !important;
        }
        
        /* Preview editable styles */
        .preview-editable {
          cursor: text;
        }
        .preview-editable:hover {
          outline: 2px dashed #007bff;
          outline-offset: 2px;
        }
        .preview-editable:focus {
          outline: 2px solid #007bff;
          outline-offset: 2px;
        }
        .inline-edit-input {
          width: 100%;
          padding: 4px 8px;
          border: 2px solid #007bff;
          border-radius: 4px;
          font-family: inherit;
          font-size: inherit;
          background: #fff;
        }
        .inline-edit-textarea {
          width: 100%;
          min-height: 100px;
          padding: 8px;
          border: 2px solid #007bff;
          border-radius: 4px;
          font-family: inherit;
          font-size: inherit;
          resize: vertical;
          background: #fff;
        }
        
        /* Toast notification */
        .toast {
          position: fixed;
          bottom: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: #333;
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 10000;
          opacity: 0;
          transition: opacity 0.3s ease;
          font-size: 14px;
        }
        .toast.show {
          opacity: 1;
        }
        
        /* Word count panel */
        #word-count {
          position: fixed;
          bottom: 10px;
          right: 10px;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 5px 12px;
          border-radius: 15px;
          font-size: 12px;
          z-index: 100;
          display: none;
        }
        
        /* Outline/TOC panel */
        #outline-panel {
          position: fixed;
          right: 0;
          top: 0;
          width: 250px;
          height: 100vh;
          background: white;
          border-left: 1px solid var(--border-color);
          z-index: 500;
          overflow-y: auto;
          transform: translateX(100%);
          transition: transform 0.3s ease;
          padding: 15px;
        }
        #outline-panel.show {
          transform: translateX(0);
        }
        #outline-panel h3 {
          margin: 0 0 15px 0;
          font-size: 14px;
          color: #666;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        #outline-panel .close-outline {
          cursor: pointer;
          padding: 5px;
          border: none;
          background: none;
          font-size: 16px;
        }
        #outline-list {
          list-style: none;
          padding: 0;
          margin: 0;
        }
        #outline-list li {
          padding: 5px 0;
          cursor: pointer;
          color: var(--link-color);
          font-size: 13px;
          border-bottom: 1px solid #f0f0f0;
        }
        #outline-list li:hover {
          background: #f8f9fa;
        }
        #outline-list li.level-1 { padding-left: 0; font-weight: bold; }
        #outline-list li.level-2 { padding-left: 15px; }
        #outline-list li.level-3 { padding-left: 30px; }
        #outline-list li.level-4 { padding-left: 45px; }
        #outline-list li.level-5 { padding-left: 60px; }
        #outline-list li.level-6 { padding-left: 75px; }
        
        /* Search and Replace panel */
        #search-panel {
          position: fixed;
          top: 50px;
          right: 60px;
          background: white;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          padding: 15px;
          z-index: 600;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: none;
          width: 300px;
        }
        #search-panel input {
          width: 100%;
          padding: 8px;
          border: 1px solid var(--border-color);
          border-radius: 4px;
          margin-bottom: 8px;
          font-size: 14px;
        }
        #search-panel .search-buttons {
          display: flex;
          gap: 8px;
          margin-top: 8px;
        }
        #search-panel button {
          flex: 1;
          padding: 8px;
          border: 1px solid var(--border-color);
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 13px;
        }
        #search-panel button:hover {
          background: var(--button-hover);
        }
        #search-panel .search-info {
          font-size: 12px;
          color: #666;
          margin-top: 8px;
        }
        
        /* Theme switcher */
        .dark-theme {
          --sidebar-bg: #1e1e1e;
          --toolbar-bg: #2d2d2d;
          --editor-bg: #1e1e1e;
          --border-color: #404040;
          --text-color: #d4d4d4;
          --link-color: #4fc3f7;
          --blockquote-color: #9e9e9e;
          --code-bg: rgba(255,255,255,0.1);
          --table-border: #404040;
          --table-alt-bg: #2d2d2d;
          --button-hover: #404040;
        }
        .dark-theme body, .dark-theme #preview-container, .dark-theme #preview {
          background-color: #1e1e1e;
          color: #d4d4d4;
        }
        .dark-theme #editor {
          background-color: #1e1e1e;
          color: #d4d4d4;
        }
        .dark-theme #outline-panel, .dark-theme #search-panel {
          background: #2d2d2d;
          color: #d4d4d4;
        }
        .dark-theme #search-panel input {
          background: #1e1e1e;
          color: #d4d4d4;
          border-color: #404040;
        }
        
        /* Print styles */
        @media print {
          /* 禁用所有过渡和动画 - 关键性能优化 */
          *, *::before, *::after {
            transition: none !important;
            animation: none !important;
            -webkit-transition: none !important;
          }
          
          /* 隐藏不需要打印的元素 */
          #sidebar, #toolbar, .diagram-toolbar, #word-count, 
          #outline-panel, #search-panel, #pwa-banner, #dropzone,
          .toast {
            display: none !important;
          }
          
          /* 重置 body 布局 */
          body {
            display: block !important;
            height: auto !important;
            overflow: visible !important;
            background: white !important;
          }
          
          #main-container {
            display: block !important;
            overflow: visible !important;
          }
          
          #editor-section {
            display: none !important;
          }
          
          #editor-container {
            display: block !important;
          }
          
          /* 关键修复: 重置 preview-container 的限制 */
          #preview-container {
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
            background: white !important;
          }
          
          #preview {
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            background: white !important;
          }
          
          /* 简化代码块样式 */
          #preview pre, #preview code {
            background: #f5f5f5 !important;
            border: 1px solid #ddd !important;
            box-shadow: none !important;
          }
          
          /* 确保图片和图表不被截断 */
          #preview img, 
          #preview svg,
          .diagram-container,
          .mermaid-container,
          .mermaid {
            max-width: 100% !important;
            page-break-inside: avoid;
            break-inside: avoid;
          }
          
          /* 避免标题和内容分离 */
          #preview h1, #preview h2, #preview h3, 
          #preview h4, #preview h5, #preview h6 {
            page-break-after: avoid;
            break-after: avoid;
          }
          
          /* 避免表格和代码块被截断 */
          #preview table, #preview pre, #preview blockquote {
            page-break-inside: avoid;
            break-inside: avoid;
          }
          
          /* 隐藏图标字体减少渲染 */
          .fas, .fab, .far, .fa {
            display: none !important;
          }
        }
        
        #pwa-banner { position: fixed; bottom: 0; left: 0; right: 0; background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 10px 20px; display: none; align-items: center; justify-content: space-between; z-index: 1000; }
        #pwa-banner button { padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #pwa-close { background: none !important; border: none !important; font-size: 20px; cursor: pointer; padding: 0 10px; }
        @media (max-width: 768px) {
            #editor-container { flex-direction: column; }
            #editor-section, #preview-container { width: 100%; height: 50%; }
            #editor-section { border-right: none; border-bottom: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button id="open-btn" title="Open file"><i class="fas fa-folder-open"></i></button>
        <button id="new-btn" title="New file"><i class="fas fa-file"></i></button>
        <button id="edit-btn" title="Edit mode" style="display: none;"><i class="fas fa-edit"></i></button>
        <button id="save-btn" title="Save file" style="display: none;"><i class="fas fa-save"></i></button>
        <button id="outline-btn" title="Toggle Outline" style="display: none;"><i class="fas fa-list-alt"></i></button>
        <button id="search-btn" title="Search & Replace" style="display: none;"><i class="fas fa-search"></i></button>
        <button id="theme-btn" title="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
        <button id="print-btn" title="Print/Export PDF" style="display: none;"><i class="fas fa-print"></i></button>
        <button id="wide-mode-btn" title="Toggle Wide Mode" style="display: none;"><i class="fas fa-arrows-alt-h"></i></button>
        <button id="export-md-btn" title="Export as HTML" style="display: none;"><i class="fas fa-file-export"></i></button>
    </div>
    <div id="main-container">
        <div id="dropzone">
            <div id="dropzone-icon"><i class="fas fa-file-alt"></i></div>
            <div>Click or drop a markdown file here to open</div>
            
            <div class="dropzone-action-separator">- OR -</div>
            <button id="create-new-btn-landing"><i class="fas fa-plus"></i> Create New File</button>
        </div>
        <div id="editor-container">
            <div id="editor-section">
                <div id="toolbar">
                    <button title="Bold" onclick="insertMarkdown('**', '**')"><i class="fas fa-bold"></i></button>
                    <button title="Italic" onclick="insertMarkdown('*', '*')"><i class="fas fa-italic"></i></button>
                    <button title="Strikethrough" onclick="insertMarkdown('~~', '~~')"><i class="fas fa-strikethrough"></i></button>
                    <button title="Heading 1" onclick="insertHeading(1)">H1</button>
                    <button title="Heading 2" onclick="insertHeading(2)">H2</button>
                    <button title="Heading 3" onclick="insertHeading(3)">H3</button>
                    <button title="Link" onclick="insertLink()"><i class="fas fa-link"></i></button>
                    <button title="Image" onclick="insertImage()"><i class="fas fa-image"></i></button>
                    <button title="Blockquote" onclick="insertBlockquote()"><i class="fas fa-quote-left"></i></button>
                    <button title="Code" onclick="insertMarkdown('`', '`')"><i class="fas fa-code"></i></button>
                    <button title="Code Block" onclick="insertCodeBlock()"><i class="fas fa-file-code"></i></button>
                    <button title="Unordered List" onclick="insertList('- ')"><i class="fas fa-list-ul"></i></button>
                    <button title="Ordered List" onclick="insertList('1. ')"><i class="fas fa-list-ol"></i></button>
                    <button title="Task List" onclick="insertList('- [ ] ')"><i class="fas fa-check-square"></i></button>
                    <button title="Horizontal Rule" onclick="insertText('---\n')"><i class="fas fa-minus"></i></button>
                    <button title="Table" onclick="insertTable()"><i class="fas fa-table"></i></button>
                    <button title="Insert Mermaid Diagram" onclick="insertMermaid()"><i class="fas fa-project-diagram"></i></button>
                    <button title="Insert PlantUML Diagram" onclick="insertPlantUML()"><i class="fas fa-sitemap"></i></button>
                    <button title="Insert Math Formula" onclick="insertMath()"><i class="fas fa-square-root-alt"></i></button>
                    <button title="Insert Footnote" onclick="insertFootnote()"><i class="fas fa-superscript"></i></button>
                    <button title="Undo" onclick="undoAction()"><i class="fas fa-undo"></i></button>
                    <button title="Redo" onclick="redoAction()"><i class="fas fa-redo"></i></button>
                    <button title="Fullscreen" onclick="toggleFullscreen()" id="fullscreen-btn"><i class="fas fa-expand"></i></button>
                </div>
                <textarea id="editor" spellcheck="false"></textarea>
            </div>
            <div id="preview-container">
                <div id="preview"></div>
            </div>
        </div>
    </div>
    
    <!-- Outline Panel -->
    <div id="outline-panel">
        <h3>Document Outline <button class="close-outline" onclick="toggleOutline()"><i class="fas fa-times"></i></button></h3>
        <ul id="outline-list"></ul>
    </div>
    
    <!-- Search & Replace Panel -->
    <div id="search-panel">
        <input type="text" id="search-input" placeholder="Search...">
        <input type="text" id="replace-input" placeholder="Replace with...">
        <div class="search-buttons">
            <button onclick="findNext()"><i class="fas fa-chevron-down"></i> Next</button>
            <button onclick="findPrev()"><i class="fas fa-chevron-up"></i> Prev</button>
            <button onclick="replaceOne()">Replace</button>
            <button onclick="replaceAll()">All</button>
        </div>
        <div class="search-info" id="search-info"></div>
    </div>
    
    <!-- Word Count -->
    <div id="word-count"></div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <div id="pwa-banner">
        <div>Install this app on your device for easier access</div>
        <div>
            <button id="pwa-install">Install</button>
            <button id="pwa-close"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        // Elements
        const dropzone = document.getElementById('dropzone');
        const editorContainer = document.getElementById('editor-container');
        const editor = document.getElementById('editor');
        const editorSection = document.getElementById('editor-section');
        const previewContainer = document.getElementById('preview-container');
        const preview = document.getElementById('preview');
        const openBtn = document.getElementById('open-btn');
        const editBtn = document.getElementById('edit-btn');
        const saveBtn = document.getElementById('save-btn');
        const newBtn = document.getElementById('new-btn');
        const createNewBtnLanding = document.getElementById('create-new-btn-landing');
        const pwaBanner = document.getElementById('pwa-banner');
        const pwaInstallBtn = document.getElementById('pwa-install');
        const pwaCloseBtn = document.getElementById('pwa-close');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const outlineBtn = document.getElementById('outline-btn');
        const outlinePanel = document.getElementById('outline-panel');
        const outlineList = document.getElementById('outline-list');
        const searchBtn = document.getElementById('search-btn');
        const searchPanel = document.getElementById('search-panel');
        const searchInput = document.getElementById('search-input');
        const replaceInput = document.getElementById('replace-input');
        const searchInfo = document.getElementById('search-info');
        const themeBtn = document.getElementById('theme-btn');
        const printBtn = document.getElementById('print-btn');
        const wideModeBtn = document.getElementById('wide-mode-btn');
        const exportMdBtn = document.getElementById('export-md-btn');
        const wordCountEl = document.getElementById('word-count');
        const toastEl = document.getElementById('toast');

        let currentFileName = '';
        let editMode = false;
        let fileLoaded = false;
        let undoStack = [];
        let redoStack = [];
        let deferredPrompt = null;
        let isScrollingProgrammatically = false;
        let searchMatches = [];
        let currentMatchIndex = -1;
        let isDarkTheme = localStorage.getItem('darkTheme') === 'true';
        let isWideMode = localStorage.getItem('wideMode') === 'true';
        
        // Apply saved theme
        if (isDarkTheme) {
            document.documentElement.classList.add('dark-theme');
            themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
        }
        
        // Apply saved wide mode
        if (isWideMode) {
            previewContainer.classList.add('wide-mode');
            wideModeBtn.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
        }

        // --- Helper Function: Escape HTML ---
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Custom marked.js renderer
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            if (language === 'plantuml') {
                const encoded = plantumlEncoder.encode(code);
                const server = window.plantumlServer || 'https://www.plantuml.com/plantuml';
                const url = `${server}/svg/${encoded}`;
                const pngUrl = `${server}/png/${encoded}`;
                return `
                    <div class="diagram-container" data-plantuml="${encoded}" data-code="${escapeHtml(code)}">
                        <div class="diagram-loading">Rendering PlantUML...</div>
                        <img src="${url}" alt="PlantUML Diagram" loading="lazy"
                             onload="this.parentElement.querySelector('.diagram-loading').style.display='none'"
                             onerror="this.parentElement.innerHTML='<div class=\\'diagram-error\\'>Failed to render PlantUML diagram</div>'">
                        <div class="diagram-toolbar">
                            <div class="diagram-export-dropdown">
                                <button><i class="fas fa-download"></i> Export ▼</button>
                                <div class="dropdown-content">
                                    <button onclick="downloadSVG(this.closest('.diagram-container'), 'plantuml')"><i class="fas fa-file-code"></i> SVG</button>
                                    <button onclick="downloadPNG(this.closest('.diagram-container'), 'plantuml')"><i class="fas fa-file-image"></i> PNG</button>
                                    <button onclick="copyDiagramCode(this.closest('.diagram-container'))"><i class="fas fa-copy"></i> Copy Code</button>
                                </div>
                            </div>
                            <button onclick="zoomDiagram(this.closest('.diagram-container'), 1.2)" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                            <button onclick="zoomDiagram(this.closest('.diagram-container'), 0.8)" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                            <button onclick="resetZoom(this.closest('.diagram-container'))" title="Reset Zoom"><i class="fas fa-undo"></i></button>
                        </div>
                    </div>`;
            } else if (language === 'mermaid') {
                const escapedCode = escapeHtml(code);
              return `
                    <div class="mermaid-container" data-code="${escapedCode}">
                        <div class="mermaid">${code}</div>
                        <div class="diagram-toolbar">
                            <div class="diagram-export-dropdown">
                                <button><i class="fas fa-download"></i> Export ▼</button>
                                <div class="dropdown-content">
                                    <button onclick="downloadSVG(this.closest('.mermaid-container'), 'mermaid')"><i class="fas fa-file-code"></i> SVG</button>
                                    <button onclick="downloadPNG(this.closest('.mermaid-container'), 'mermaid')"><i class="fas fa-file-image"></i> PNG</button>
                                    <button onclick="copyDiagramCode(this.closest('.mermaid-container'))"><i class="fas fa-copy"></i> Copy Code</button>
                                </div>
                            </div>
                            <button onclick="zoomDiagram(this.closest('.mermaid-container'), 1.2)" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                            <button onclick="zoomDiagram(this.closest('.mermaid-container'), 0.8)" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                            <button onclick="resetZoom(this.closest('.mermaid-container'))" title="Reset Zoom"><i class="fas fa-undo"></i></button>
                        </div>
                    </div>`;
            }  else {
                // FIXED: Robust handling for highlight.js
                let highlightedCode;
                let validLang = false;

                if (language && typeof hljs !== 'undefined' && hljs.getLanguage(language)) {
                    validLang = true;
                    try {
                        highlightedCode = hljs.highlight(code, { language: language }).value;
                    } catch (e) {
                        validLang = false;
                    }
                }

                // Fallback: If no language, invalid language, or error, escape HTML manually
                if (!validLang) {
                    highlightedCode = escapeHtml(code);
                }

                // Add 'hljs' class to code tag for proper styling from the theme
                return `<pre><code class="hljs language-${language || 'plaintext'}">${highlightedCode}</code></pre>`;
            }
        };

        marked.setOptions({
            renderer: renderer,
            breaks: true,
            gfm: true,
            tables: true,
            smartLists: true,
            smartypants: true
        });

        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            pwaBanner.style.display = 'flex';
        });

        pwaInstallBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                pwaBanner.style.display = 'none';
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            }
        });

        pwaCloseBtn.addEventListener('click', () => { pwaBanner.style.display = 'none'; });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').catch(err => console.log('SW failed', err));
            });
        }

        function renderMarkdown(text) {
            // Optimization: If preview is hidden, skip rendering
            if (previewContainer.offsetParent === null) return;

            const html = marked.parse(text);
            preview.innerHTML = joypixels.shortnameToImage(html);

            requestAnimationFrame(() => {
                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({
                        startOnLoad: false,
                        securityLevel: 'strict',
                        theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default',
                        flowchart: { useMaxWidth: true, htmlLabels: true },
                        er: { useMaxWidth: true },
                        sequence: { useMaxWidth: true, noteFontWeight: 'normal' }
                    });

                    setTimeout(() => {
                        try {
                            mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                        } catch (error) {
                            // Suppress partial render errors while typing
                            // console.warn('Mermaid partial render error', error);
                        }
                    }, 10);
                }

                setTimeout(() => {
                    if (window.renderMathInElement) {
                        renderMathInElement(preview, {
                            delimiters: [
                                { left: '$$', right: '$$', display: true },
                                { left: '$', right: '$', display: false },
                            ],
                            throwOnError: false,
                            ignoredTags: ["script", "noscript", "style", "textarea", "pre", "code"],
                            ignoredClasses: ["mermaid-diagram", "diagram-container"]
                        });
                    }
                }, 20);
            });

            const checkboxes = preview.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = false;
                checkbox.addEventListener('change', handleTaskCheckbox);
            });
            
            // Update outline
            updateOutline();
            
            // Update word count
            updateWordCount();
            
            // Make preview elements editable in view mode
            if (!editMode) {
                makePreviewEditable();
            }
        }

        function handleTaskCheckbox() {
             const listItem = this.closest('li');
            const listItemIndex = Array.from(listItem.parentNode.children).indexOf(listItem);
            const lines = editor.value.split('\n');
            let currentListIndex = -1;
            let lineIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].match(/^- \[[ x]\]/i)) {
                    currentListIndex++;
                    if (currentListIndex === listItemIndex) {
                        lineIndex = i;
                        break;
                    }
                }
            }

            if (lineIndex !== -1) {
                saveToUndoStack();
                lines[lineIndex] = lines[lineIndex].replace(
                    /^- \[[ x]\]/i,
                    `- [${this.checked ? 'x' : ' '}]`
                );
                editor.value = lines.join('\n');
                renderMarkdown(editor.value);
            }
        }

        function openFile(file) {
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.md')) {
                alert('Please select a Markdown (.md) file.');
                return;
            }

            currentFileName = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                editor.value = content;
                
                fileLoaded = true;
                setViewMode(); 
                
                renderMarkdown(content);

                editBtn.style.display = 'flex';
                saveBtn.style.display = 'flex';
                outlineBtn.style.display = 'flex';
                searchBtn.style.display = 'flex';
                printBtn.style.display = 'flex';
                wideModeBtn.style.display = 'flex';
                exportMdBtn.style.display = 'flex';
                wordCountEl.style.display = 'block';
                undoStack = [];
                redoStack = [];
                saveToUndoStack();
            };
            reader.readAsText(file);
        }

        function setViewMode() {
            editMode = false;
            if (fileLoaded) {
                dropzone.style.display = 'none';
                editorContainer.style.display = 'flex';
                editorSection.style.display = 'none';
                previewContainer.style.display = 'block';
                previewContainer.style.width = '100%';
            }
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.title = 'Edit mode';
        }

        function setEditMode() {
            editMode = true;
            if (fileLoaded) {
                dropzone.style.display = 'none';
                editorContainer.style.display = 'flex';
                editorSection.style.display = 'flex';
                previewContainer.style.display = 'block';
                previewContainer.style.width = '50%';
                
                renderMarkdown(editor.value);
            }
            editBtn.innerHTML = '<i class="fas fa-eye"></i>';
            editBtn.title = 'View mode';
        }

        function saveFile() {
            const content = editor.value;
            const blob = new Blob([content], { type: 'text/markdown' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentFileName || 'document.md';
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function newFile() {
            if (fileLoaded && editor.value && !confirm('Discard current document?')) return;
            currentFileName = '';
            editor.value = '';
            
            fileLoaded = true;
            setEditMode(); 
            
            renderMarkdown('');

            editBtn.style.display = 'flex';
            saveBtn.style.display = 'flex';
            outlineBtn.style.display = 'flex';
            searchBtn.style.display = 'flex';
            printBtn.style.display = 'flex';
            wideModeBtn.style.display = 'flex';
            exportMdBtn.style.display = 'flex';
            wordCountEl.style.display = 'block';
            undoStack = [];
            redoStack = [];
            saveToUndoStack();
        }

        function saveToUndoStack() {
            if (undoStack.length >= 50) undoStack.shift();
            undoStack.push(editor.value);
            redoStack = [];
        }

        function undoAction() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                const previousState = undoStack[undoStack.length - 1];
                editor.value = previousState;
                renderMarkdown(previousState);
            }
        }

        function redoAction() {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                editor.value = nextState;
                renderMarkdown(nextState);
            }
        }

        function toggleFullscreen() {
            const doc = document.documentElement;
            if (!document.fullscreenElement) {
                if (doc.requestFullscreen) doc.requestFullscreen();
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = "Exit Fullscreen";
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = "Fullscreen";
            }
        }

        // Event listeners
        function openFileDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.md';
            input.onchange = function(e) {
                if (e.target.files.length > 0) openFile(e.target.files[0]);
            };
            input.click();
        }

        dropzone.addEventListener('click', openFileDialog);
        openBtn.addEventListener('click', openFileDialog);

        createNewBtnLanding.addEventListener('click', function(e) {
            e.stopPropagation();
            newFile();
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            }, false);
            document.body.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        dropzone.addEventListener('dragenter', function() { this.style.backgroundColor = '#e9e9e9'; });
        dropzone.addEventListener('dragleave', function() { this.style.backgroundColor = ''; });
        dropzone.addEventListener('drop', function(e) {
            this.style.backgroundColor = '';
            if (e.dataTransfer.files.length > 0) openFile(e.dataTransfer.files[0]);
        });

        editBtn.addEventListener('click', function() {
            if (editMode) setViewMode();
            else setEditMode();
        });

        saveBtn.addEventListener('click', saveFile);
        newBtn.addEventListener('click', newFile);
        outlineBtn.addEventListener('click', toggleOutline);
        searchBtn.addEventListener('click', toggleSearch);
        themeBtn.addEventListener('click', toggleTheme);
        printBtn.addEventListener('click', printDocument);
        wideModeBtn.addEventListener('click', toggleWideMode);
        exportMdBtn.addEventListener('click', exportAsHTML);
        
        // Search input events
        searchInput.addEventListener('input', function() {
            findMatches(this.value);
        });
        
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) findPrev();
                else findNext();
            }
            if (e.key === 'Escape') {
                searchPanel.style.display = 'none';
            }
        });

        let syncScrollPending = false;
        editor.addEventListener('scroll', function() {
            if (editMode && !isScrollingProgrammatically && !syncScrollPending) {
                syncScrollPending = true;
                window.requestAnimationFrame(() => {
                    const editorScrollPercentage = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
                    const previewScrollPosition = editorScrollPercentage * (previewContainer.scrollHeight - previewContainer.clientHeight);
                    isScrollingProgrammatically = true;
                    previewContainer.scrollTop = previewScrollPosition;
                    setTimeout(() => { isScrollingProgrammatically = false; }, 50);
                    syncScrollPending = false;
                });
            }
        });

        let syncPreviewScrollPending = false;
        previewContainer.addEventListener('scroll', function() {
            if (editMode && !isScrollingProgrammatically && !syncPreviewScrollPending) {
                syncPreviewScrollPending = true;
                window.requestAnimationFrame(() => {
                    const previewScrollPercentage = previewContainer.scrollTop / (previewContainer.scrollHeight - previewContainer.clientHeight);
                    const editorScrollPosition = previewScrollPercentage * (editor.scrollHeight - editor.clientHeight);
                    isScrollingProgrammatically = true;
                    editor.scrollTop = editorScrollPosition;
                     setTimeout(() => { isScrollingProgrammatically = false; }, 50);
                    syncPreviewScrollPending = false;
                });
            }
        });

        let debounceTimeout;
        editor.addEventListener('input', function() {
            clearTimeout(debounceTimeout);
            const contentLen = editor.value.length;
            let delay = 300;
            if (contentLen > 50000) delay = 800;
            if (contentLen > 200000) delay = 1500;

            debounceTimeout = setTimeout(() => {
                saveToUndoStack();
                renderMarkdown(editor.value);
            }, delay);
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undoAction(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) { e.preventDefault(); redoAction(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redoAction(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveFile(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') { e.preventDefault(); openFileDialog(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); newFile(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (fileLoaded) editMode ? setViewMode() : setEditMode();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                if (fileLoaded) toggleSearch();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                if (fileLoaded) printDocument();
            }
            if (e.key === 'F11') { e.preventDefault(); toggleFullscreen(); }
            if (e.key === 'Escape') {
                searchPanel.style.display = 'none';
                outlinePanel.classList.remove('show');
            }
        });

        function getSelectionOrLineInfo() {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            if (start !== end) {
                return { selection: text.substring(start, end), start: start, end: end };
            }
            let lineStart = start;
            while (lineStart > 0 && text[lineStart - 1] !== '\n') lineStart--;
            let lineEnd = end;
            while (lineEnd < text.length && text[lineEnd] !== '\n') lineEnd++;
            return { selection: text.substring(lineStart, lineEnd), start: lineStart, end: lineEnd };
        }

        function insertText(text) {
            saveToUndoStack();
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const editorValue = editor.value;
            editor.value = editorValue.substring(0, start) + text + editorValue.substring(end);
            editor.selectionStart = editor.selectionEnd = start + text.length;
            editor.focus();
		    renderMarkdown(editor.value);
        }

        function insertMarkdown(prefix, suffix) {
            saveToUndoStack();
            const info = getSelectionOrLineInfo();
            const start = info.start;
            const end = info.end;
            const newText = prefix + info.selection + suffix;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            editor.selectionStart = start + newText.length;
            editor.selectionEnd = start + newText.length;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertHeading(level) {
            saveToUndoStack();
            const info = getSelectionOrLineInfo();
            const start = info.start;
            const end = info.end;
            let cleanText = info.selection.replace(/^#+\s*/, '');
            const prefix = '#'.repeat(level) + ' ';
            const newText = prefix + cleanText;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + newText.length;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertLink() {
            saveToUndoStack();
            const info = getSelectionOrLineInfo();
            const start = info.start;
            const end = info.end;
            let linkText = info.selection || 'link text';
            let newText = `[${linkText}](https://)`;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            editor.selectionStart = start + linkText.length + 3;
            editor.selectionEnd = start + newText.length - 1;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertImage() {
            saveToUndoStack();
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selection = editor.value.substring(start, end);
            let altText = selection || 'alt text';
            let newText = `![${altText}](image-url)`;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            editor.selectionStart = start + altText.length + 4;
            editor.selectionEnd = start + newText.length - 1;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertBlockquote() {
            saveToUndoStack();
            const info = getSelectionOrLineInfo();
            const start = info.start;
            const end = info.end;
            const lines = info.selection.split('\n');
            const quotedLines = lines.map(line => `> ${line}`).join('\n');
            editor.value = editor.value.substring(0, start) + quotedLines + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + quotedLines.length;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertCodeBlock() {
            saveToUndoStack();
            const info = getSelectionOrLineInfo();
            const start = info.start;
            const end = info.end;
            const newText = '```\n' + info.selection + '\n```';
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            editor.selectionStart = start + 4;
            editor.selectionEnd = start + 4 + info.selection.length;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertList(prefix) {
            saveToUndoStack();
            const info = getSelectionOrLineInfo();
            const start = info.start;
            const end = info.end;
            const lines = info.selection.split('\n');
            const listedLines = lines.map(line => `${prefix}${line}`).join('\n');
            editor.value = editor.value.substring(0, start) + listedLines + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + listedLines.length;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function insertTable() {
            saveToUndoStack();
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const table = `| Header 1 | Header 2 | Header 3 |\n| -------- | -------- | -------- |\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |`;
            editor.value = editor.value.substring(0, start) + table + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + table.length;
            editor.focus();
            renderMarkdown(editor.value);
        }

        function downloadSVG(container, type) {
            if (type === 'plantuml') {
                const img = container.querySelector('img');
                if (!img) return;
                const a = document.createElement('a');
                a.href = img.src;
                a.download = 'plantuml-diagram.svg';
                a.click();
                showToast('SVG diagram downloaded!');
            } else if (type === 'mermaid') {
                const svgElement = container.querySelector('svg');
                if (!svgElement) return;
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svgElement);
                // Add XML declaration and proper namespace
                if (!svgString.includes('xmlns')) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mermaid-diagram.svg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('SVG diagram downloaded!');
            }
        }
        
        async function downloadPNG(container, type) {
            showToast('Generating PNG...');
            
            if (type === 'plantuml') {
                // For PlantUML, get PNG from server
                const encoded = container.dataset.plantuml;
                const server = window.plantumlServer || 'https://www.plantuml.com/plantuml';
                const pngUrl = `${server}/png/${encoded}`;
                
                try {
                    const response = await fetch(pngUrl);
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'plantuml-diagram.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('PNG diagram downloaded!');
                } catch (error) {
                    // Fallback: open in new tab
                    window.open(pngUrl, '_blank');
                    showToast('PNG opened in new tab');
                }
            } else if (type === 'mermaid') {
                // For Mermaid, convert SVG to PNG using canvas
                const svgElement = container.querySelector('svg');
                if (!svgElement) {
                    showToast('No SVG found to export');
                    return;
                }
                
                try {
                    // Use html2canvas if available
                    if (typeof html2canvas !== 'undefined') {
                        const canvas = await html2canvas(container.querySelector('.mermaid'), {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'mermaid-diagram.png';
                            a.click();
                            URL.revokeObjectURL(url);
                            showToast('PNG diagram downloaded!');
                        }, 'image/png');
                    } else {
                        // Fallback: SVG to PNG conversion
                        const serializer = new XMLSerializer();
                        let svgString = serializer.serializeToString(svgElement);
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        
                        const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                        const url = URL.createObjectURL(svgBlob);
                        
                        img.onload = function() {
                            canvas.width = img.width * 2;
                            canvas.height = img.height * 2;
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            canvas.toBlob(function(blob) {
                                const pngUrl = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = pngUrl;
                                a.download = 'mermaid-diagram.png';
                                a.click();
                                URL.revokeObjectURL(pngUrl);
                                showToast('PNG diagram downloaded!');
                            }, 'image/png');
                            
                            URL.revokeObjectURL(url);
                        };
                        
                        img.src = url;
                    }
                } catch (error) {
                    console.error('PNG export error:', error);
                    showToast('Failed to export PNG');
                }
            }
        }
        
        function copyDiagramCode(container) {
            const code = container.dataset.code;
            if (code) {
                // Decode HTML entities
                const textarea = document.createElement('textarea');
                textarea.innerHTML = code;
                const decodedCode = textarea.value;
                
                navigator.clipboard.writeText(decodedCode).then(() => {
                    showToast('Diagram code copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy code');
                });
            }
        }
        
        function zoomDiagram(container, factor) {
            const currentScale = parseFloat(container.dataset.scale || '1');
            const newScale = Math.max(0.25, Math.min(4, currentScale * factor));
            container.dataset.scale = newScale;
            
            const content = container.querySelector('img, svg, .mermaid');
            if (content) {
                content.style.transform = `scale(${newScale})`;
                content.style.transformOrigin = 'top left';
            }
        }
        
        function resetZoom(container) {
            container.dataset.scale = '1';
            const content = container.querySelector('img, svg, .mermaid');
            if (content) {
                content.style.transform = 'scale(1)';
            }
        }
        
        // Toast notification
        function showToast(message, duration = 2000) {
            toastEl.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, duration);
        }
        
        // Make preview elements editable (for view mode)
        function makePreviewEditable() {
            const editableElements = preview.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, td, th');
            
            editableElements.forEach((el, index) => {
                el.classList.add('preview-editable');
                el.dataset.editIndex = index;
                
                el.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    startInlineEdit(this);
                });
            });
        }
        
        function startInlineEdit(element) {
            if (element.querySelector('.inline-edit-input, .inline-edit-textarea')) return;
            
            const originalText = element.textContent;
            const tagName = element.tagName.toLowerCase();
            const isMultiline = tagName === 'blockquote' || originalText.length > 100;
            
            element.dataset.originalHtml = element.innerHTML;
            
            if (isMultiline) {
                element.innerHTML = `<textarea class="inline-edit-textarea">${originalText}</textarea>`;
            } else {
                element.innerHTML = `<input type="text" class="inline-edit-input" value="${originalText.replace(/"/g, '&quot;')}">`;
            }
            
            const input = element.querySelector('input, textarea');
            input.focus();
            input.select();
            
            input.addEventListener('blur', function() {
                finishInlineEdit(element, this.value, originalText);
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !isMultiline) {
                    e.preventDefault();
                    this.blur();
                }
                if (e.key === 'Escape') {
                    element.innerHTML = element.dataset.originalHtml;
                }
                if (e.key === 'Enter' && e.ctrlKey && isMultiline) {
                    e.preventDefault();
                    this.blur();
                }
            });
        }
        
        function finishInlineEdit(element, newText, originalText) {
            if (newText === originalText) {
                element.innerHTML = element.dataset.originalHtml;
                return;
            }
            
            // Find and replace in editor
            const lines = editor.value.split('\n');
            let found = false;
            
            for (let i = 0; i < lines.length; i++) {
                // Simple text match - look for the original text in the line
                if (lines[i].includes(originalText)) {
                    lines[i] = lines[i].replace(originalText, newText);
                    found = true;
                    break;
                }
            }
            
            if (found) {
                saveToUndoStack();
                editor.value = lines.join('\n');
                renderMarkdown(editor.value);
                showToast('Content updated!');
            } else {
                element.innerHTML = element.dataset.originalHtml;
                showToast('Could not find text to update');
            }
        }
        
        // Outline/TOC functions
        function toggleOutline() {
            outlinePanel.classList.toggle('show');
        }
        
        function updateOutline() {
            const headings = preview.querySelectorAll('h1, h2, h3, h4, h5, h6');
            outlineList.innerHTML = '';
            
            headings.forEach((heading, index) => {
                const level = parseInt(heading.tagName.charAt(1));
                const li = document.createElement('li');
                li.className = `level-${level}`;
                li.textContent = heading.textContent;
                li.addEventListener('click', () => {
                    heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
                outlineList.appendChild(li);
            });
        }
        
        // Search and Replace functions
        function toggleSearch() {
            searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';
            if (searchPanel.style.display === 'block') {
                searchInput.focus();
            }
        }
        
        function findMatches(searchText) {
            if (!searchText) {
                searchMatches = [];
                searchInfo.textContent = '';
                return;
            }
            
            const content = editor.value;
            searchMatches = [];
            let match;
            const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            
            while ((match = regex.exec(content)) !== null) {
                searchMatches.push({ start: match.index, end: match.index + match[0].length });
            }
            
            searchInfo.textContent = searchMatches.length > 0 
                ? `Found ${searchMatches.length} match(es)` 
                : 'No matches found';
            
            currentMatchIndex = searchMatches.length > 0 ? 0 : -1;
        }
        
        function findNext() {
            const searchText = searchInput.value;
            if (!searchText) return;
            
            findMatches(searchText);
            
            if (searchMatches.length === 0) return;
            
            currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
            highlightMatch();
        }
        
        function findPrev() {
            const searchText = searchInput.value;
            if (!searchText) return;
            
            findMatches(searchText);
            
            if (searchMatches.length === 0) return;
            
            currentMatchIndex = currentMatchIndex <= 0 ? searchMatches.length - 1 : currentMatchIndex - 1;
            highlightMatch();
        }
        
        function highlightMatch() {
            if (currentMatchIndex < 0 || currentMatchIndex >= searchMatches.length) return;
            
            const match = searchMatches[currentMatchIndex];
            editor.focus();
            editor.setSelectionRange(match.start, match.end);
            
            // Scroll to selection
            const lineHeight = 20;
            const linesBeforeMatch = editor.value.substring(0, match.start).split('\n').length;
            editor.scrollTop = (linesBeforeMatch - 5) * lineHeight;
            
            searchInfo.textContent = `Match ${currentMatchIndex + 1} of ${searchMatches.length}`;
        }
        
        function replaceOne() {
            const searchText = searchInput.value;
            const replaceText = replaceInput.value;
            
            if (!searchText || currentMatchIndex < 0) return;
            
            saveToUndoStack();
            
            const match = searchMatches[currentMatchIndex];
            editor.value = editor.value.substring(0, match.start) + replaceText + editor.value.substring(match.end);
            
            renderMarkdown(editor.value);
            findMatches(searchText);
            showToast('Replaced 1 match');
        }
        
        function replaceAll() {
            const searchText = searchInput.value;
            const replaceText = replaceInput.value;
            
            if (!searchText) return;
            
            saveToUndoStack();
            
            const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            const count = (editor.value.match(regex) || []).length;
            
            editor.value = editor.value.replace(regex, replaceText);
            renderMarkdown(editor.value);
            
            searchMatches = [];
            currentMatchIndex = -1;
            searchInfo.textContent = `Replaced ${count} match(es)`;
            showToast(`Replaced ${count} matches`);
        }
        
        // Word count
        function updateWordCount() {
            const text = editor.value;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            const lines = text.split('\n').length;
            wordCountEl.innerHTML = `<i class="fas fa-file-word"></i> ${words} words | ${chars} chars | ${lines} lines`;
        }
        
        // Theme toggle
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.documentElement.classList.toggle('dark-theme');
            localStorage.setItem('darkTheme', isDarkTheme);
            themeBtn.innerHTML = isDarkTheme ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            showToast(isDarkTheme ? 'Dark theme enabled' : 'Light theme enabled');
        }
        
        // Print function - 使用新窗口打印以提高性能
        function printDocument() {
            // 创建一个简化的打印窗口
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            // 获取预览内容
            const content = preview.innerHTML;
            
            // 构建简化的 HTML，只包含必要的样式
            const printHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${currentFileName || 'Print Document'}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; 
            color: #24292e; 
            padding: 20px;
            max-width: 100%;
        }
        h1, h2 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; margin-top: 24px; margin-bottom: 16px; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.25em; margin-top: 24px; margin-bottom: 16px; }
        h4, h5, h6 { margin-top: 24px; margin-bottom: 16px; }
        p { margin-bottom: 16px; }
        pre { padding: 16px; background: #f6f8fa; border-radius: 6px; overflow: auto; margin-bottom: 16px; }
        code { font-family: Consolas, monospace; font-size: 85%; background: rgba(27,31,35,0.05); padding: 0.2em 0.4em; border-radius: 3px; }
        pre code { background: transparent; padding: 0; }
        blockquote { padding: 0 1em; color: #6a737d; border-left: 0.25em solid #dfe2e5; margin: 0 0 16px 0; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 16px; }
        th, td { padding: 6px 13px; border: 1px solid #dfe2e5; }
        tr:nth-child(2n) { background: #f6f8fa; }
        img { max-width: 100%; }
        ul, ol { padding-left: 2em; margin-bottom: 16px; }
        a { color: #0366d6; text-decoration: none; }
        hr { height: 0.25em; background: #e1e4e8; border: 0; margin: 24px 0; }
        .diagram-toolbar { display: none !important; }
        @media print {
            body { padding: 0; }
            pre, blockquote, table, img { page-break-inside: avoid; }
            h1, h2, h3, h4, h5, h6 { page-break-after: avoid; }
        }
    </style>
</head>
<body>
${content}
<script>
    window.onload = function() {
        setTimeout(function() {
            window.print();
            window.onafterprint = function() { window.close(); };
        }, 300);
    };
</script>
</body>
</html>`;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
        }
        
        // Toggle wide mode
        function toggleWideMode() {
            isWideMode = !isWideMode;
            previewContainer.classList.toggle('wide-mode');
            localStorage.setItem('wideMode', isWideMode);
            wideModeBtn.innerHTML = isWideMode 
                ? '<i class="fas fa-compress-arrows-alt"></i>' 
                : '<i class="fas fa-arrows-alt-h"></i>';
            wideModeBtn.title = isWideMode ? 'Normal Width' : 'Wide Mode';
            showToast(isWideMode ? 'Wide mode enabled' : 'Normal width mode');
        }
        
        // Export as HTML
        function exportAsHTML() {
            const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${currentFileName || 'Document'}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css">
    <style>
        body { max-width: 980px; margin: 40px auto; padding: 20px; }
        .markdown-body { box-sizing: border-box; min-width: 200px; max-width: 980px; margin: 0 auto; }
    </style>
</head>
<body class="markdown-body">
${preview.innerHTML}
</body>
</html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = (currentFileName || 'document').replace('.md', '') + '.html';
            a.click();
            URL.revokeObjectURL(a.href);
            showToast('HTML exported!');
        }
        
        // Insert Mermaid diagram template
        function insertMermaid() {
            const template = `\`\`\`mermaid
graph TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action 1]
    B -->|No| D[Action 2]
    C --> E[End]
    D --> E
\`\`\``;
            insertText(template);
        }
        
        // Insert PlantUML diagram template
        function insertPlantUML() {
            const template = `\`\`\`plantuml
@startuml
actor User
participant "System" as S
database "Database" as DB

User -> S: Request
S -> DB: Query
DB --> S: Result
S --> User: Response
@enduml
\`\`\``;
            insertText(template);
        }
        
        // Insert Math formula
        function insertMath() {
            const template = `$$
E = mc^2
$$`;
            insertText(template);
        }
        
        // Insert Footnote
        function insertFootnote() {
            const footnoteNum = (editor.value.match(/\[\^\d+\]/g) || []).length + 1;
            insertText(`[^${footnoteNum}]`);
            // Also add footnote definition at the end
            const definition = `\n\n[^${footnoteNum}]: Footnote text here`;
            const cursorPos = editor.selectionStart;
            editor.value = editor.value + definition;
            editor.selectionStart = editor.selectionEnd = cursorPos;
        }

    </script>
</body>
</html>
