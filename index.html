<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#24292e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="MD Editor">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    
    <!-- Libraries -->
    <!-- 先加载CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- 先加载核心JS库 -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.7/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-toolkit@6.6.0/lib/js/joypixels.min.js"></script>
    
    <style>
        /* Styles remain unchanged from the original */
        :root {
            --sidebar-bg: #24292e;
            --toolbar-bg: #f1f1f1;
            --editor-bg: #f6f8fa;
            --border-color: #ddd;
            --text-color: #24292e;
            --link-color: #0366d6;
            --blockquote-color: #6a737d;
            --code-bg: rgba(27,31,35,0.05);
            --table-border: #dfe2e5;
            --table-alt-bg: #f6f8fa;
            --button-hover: #e1e4e8;
        }

        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; background-color: #f5f5f5; color: var(--text-color); }
        #sidebar { width: 40px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        #sidebar button { background: none; border: none; color: white; font-size: 16px; margin-bottom: 15px; cursor: pointer; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 5px; transition: background-color 0.2s; }
        #sidebar button:hover { background-color: #444; }
        #main-container { flex: 1; display: flex; overflow: hidden; }
        #dropzone { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; font-size: 18px; cursor: pointer; text-align: center; padding: 20px; transition: background-color 0.2s; }
        #dropzone:hover { background-color: #e9e9e9; }
        #dropzone-icon { font-size: 48px; margin-bottom: 20px; color: #999; }
        #editor-container { width: 100%; height: 100%; display: none; flex-direction: row; }
        #editor-section { width: 50%; height: 100%; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        #toolbar { background-color: var(--toolbar-bg); padding: 5px; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; }
        #toolbar button { background-color: #fff; border: 1px solid var(--border-color); border-radius: 3px; color: #333; cursor: pointer; margin-right: 5px; margin-bottom: 5px; padding: 3px 5px; font-size: 14px; transition: background-color 0.2s; }
        #toolbar button:hover { background-color: var(--button-hover); }
        #editor { flex: 1; overflow: auto; padding: 15px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 14px; line-height: 1.5; border: none; resize: none; background-color: var(--editor-bg); tab-size: 4; }
        #preview-container { width: 50%; height: 100%; overflow: auto; padding: 0; background-color: white; }
        #preview { max-width: 980px; margin: 0 auto; padding: 20px; font-size: 16px; line-height: 1.6; color: var(--text-color); word-wrap: break-word; }
        #preview h1, #preview h2 { border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h1 { font-size: 2em; }
        #preview h2 { font-size: 1.5em; }
        #preview h3 { font-size: 1.25em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h4 { font-size: 1em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h5 { font-size: 0.875em; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview h6 { font-size: 0.85em; color: #6a737d; margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        #preview blockquote { padding: 0 1em; color: var(--blockquote-color); border-left: 0.25em solid #dfe2e5; margin: 0 0 16px 0; }
        #preview pre { padding: 16px; overflow: auto; font-size: 85%; line-height: 1.45; background-color: var(--editor-bg); border-radius: 6px; margin-bottom: 16px; }
        #preview code { padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: var(--code-bg); border-radius: 3px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; }
        #preview pre code { padding: 0; background-color: transparent; border-radius: 0; }
        #preview table { border-collapse: collapse; width: 100%; margin-bottom: 16px; display: block; overflow-x: auto; }
        #preview table th, #preview table td { padding: 6px 13px; border: 1px solid var(--table-border); }
        #preview table tr { background-color: #fff; border-top: 1px solid #c6cbd1; }
        #preview table tr:nth-child(2n) { background-color: var(--table-alt-bg); }
        #preview img { max-width: 100%; box-sizing: content-box; background-color: #fff; }
        #preview p { margin-top: 0; margin-bottom: 16px; }
        #preview a { color: var(--link-color); text-decoration: none; }
        #preview a:hover { text-decoration: underline; }
        #preview ul, #preview ol { padding-left: 2em; margin-top: 0; margin-bottom: 16px; }
        #preview li+li { margin-top: 0.25em; }
        #preview hr { height: 0.25em; padding: 0; margin: 24px 0; background-color: #e1e4e8; border: 0; }
        #preview .task-list-item { list-style-type: none; }
        #preview .task-list-item-checkbox { margin: 0 0.2em 0.25em -1.6em; vertical-align: middle; }

        /* Diagram styles */
        .diagram-container, .mermaid-container {
          position: relative;
          margin: 1rem 0;
          border: 1px solid var(--border-color);
          border-radius: 4px;
          overflow: auto;
        }
        .diagram-loading {
          padding: 1rem;
          font-style: italic;
          color: #666;
        }
        .diagram-error {
          padding: 1rem;
          color: #dc3545;
          background-color: #f8d7da;
          border-radius: 4px;
        }
        .diagram-toolbar {
          position: absolute;
          top: 5px;
          right: 5px;
          display: flex;
          gap: 5px;
          z-index: 100;
        }
        .diagram-toolbar button {
          padding: 2px 8px;
          background: rgba(255,255,255,0.9);
          border: 1px solid var(--border-color);
          border-radius: 3px;
          cursor: pointer;
          font-size: 12px;
        }
        .diagram-toolbar button:hover {
          background: var(--button-hover);
        }
        #pwa-banner { position: fixed; bottom: 0; left: 0; right: 0; background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 10px 20px; display: none; align-items: center; justify-content: space-between; z-index: 1000; }
        #pwa-banner button { padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #pwa-close { background: none !important; border: none !important; font-size: 20px; cursor: pointer; padding: 0 10px; }
        @media (max-width: 768px) {
            #editor-container { flex-direction: column; }
            #editor-section, #preview-container { width: 100%; height: 50%; }
            #editor-section { border-right: none; border-bottom: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button id="open-btn" title="Open file"><i class="fas fa-folder-open"></i></button>
        <button id="edit-btn" title="Edit mode" style="display: none;"><i class="fas fa-edit"></i></button>
        <button id="save-btn" title="Save file" style="display: none;"><i class="fas fa-save"></i></button>
        <button id="new-btn" title="New file" style="display: none;"><i class="fas fa-file"></i></button>
    </div>
    <div id="main-container">
        <div id="dropzone">
            <div id="dropzone-icon"><i class="fas fa-file-alt"></i></div>
            <div>Click or drop a markdown file here to open</div>
        </div>
        <div id="editor-container">
            <div id="editor-section">
                <div id="toolbar">
                    <button title="Bold" onclick="insertMarkdown('**', '**')"><i class="fas fa-bold"></i></button>
                    <button title="Italic" onclick="insertMarkdown('*', '*')"><i class="fas fa-italic"></i></button>
                    <button title="Strikethrough" onclick="insertMarkdown('~~', '~~')"><i class="fas fa-strikethrough"></i></button>
                    <button title="Heading 1" onclick="insertHeading(1)">H1</button>
                    <button title="Heading 2" onclick="insertHeading(2)">H2</button>
                    <button title="Heading 3" onclick="insertHeading(3)">H3</button>
                    <button title="Link" onclick="insertLink()"><i class="fas fa-link"></i></button>
                    <button title="Image" onclick="insertImage()"><i class="fas fa-image"></i></button>
                    <button title="Blockquote" onclick="insertBlockquote()"><i class="fas fa-quote-left"></i></button>
                    <button title="Code" onclick="insertMarkdown('`', '`')"><i class="fas fa-code"></i></button>
                    <button title="Code Block" onclick="insertCodeBlock()"><i class="fas fa-file-code"></i></button>
                    <button title="Unordered List" onclick="insertList('- ')"><i class="fas fa-list-ul"></i></button>
                    <button title="Ordered List" onclick="insertList('1. ')"><i class="fas fa-list-ol"></i></button>
                    <button title="Task List" onclick="insertList('- [ ] ')"><i class="fas fa-check-square"></i></button>
                    <button title="Horizontal Rule" onclick="insertText('---\n')"><i class="fas fa-minus"></i></button>
                    <button title="Table" onclick="insertTable()"><i class="fas fa-table"></i></button>
                    <button title="Undo" onclick="undoAction()"><i class="fas fa-undo"></i></button>
                    <button title="Fullscreen" onclick="toggleFullscreen()" id="fullscreen-btn"><i class="fas fa-expand"></i></button>
                </div>
                <textarea id="editor" spellcheck="false"></textarea>
            </div>
            <div id="preview-container">
                <div id="preview"></div>
            </div>
        </div>
    </div>

    <div id="pwa-banner">
        <div>Install this app on your device for easier access</div>
        <div>
            <button id="pwa-install">Install</button>
            <button id="pwa-close"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        // 确保highlight.js已加载
        if (typeof hljs === 'undefined') {
            console.error('highlight.js is not loaded!');
        }

        // 用于SVG下载的辅助函数
        function downloadSVG(container, type) {
            let svgElement;
            if (type === 'mermaid') {
                svgElement = container.querySelector('svg');
            } else if (type === 'plantuml') {
                svgElement = container.querySelector('img');
            }
            
            if (!svgElement) {
                alert('No SVG element
